{% extends 'supervisor/shared/base.html' %}
{% block content %}

<div class="space-y-6">

  <!-- Page Header -->
  <div class="flex justify-between items-start">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Classes</h2>
      <p class="text-sm text-gray-500 mt-1">Manage all classes across schools</p>
    </div>
    <div class="relative group">
      <button class="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-medium text-sm shadow-sm">
        <span class="material-symbols-outlined text-[20px]">add</span>
        <span>Add Class</span>
        <span class="material-symbols-outlined text-[18px]">expand_more</span>
      </button>
      
      <!-- Dropdown Menu -->
      <div class="absolute right-0 mt-0 w-48 bg-white border border-gray-200 rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10">
        <a href="{% url 'supervisor_class_create' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-gray-50 border-b border-gray-100 first:rounded-t-lg">
          <span class="material-symbols-outlined text-[20px] text-blue-600">add_circle</span>
          <div>
            <p class="text-sm font-medium">Single Class</p>
            <p class="text-xs text-gray-500">Add one class</p>
          </div>
        </a>
        <a href="{% url 'supervisor_class_bulk_create' %}" class="flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-gray-50 last:rounded-b-lg">
          <span class="material-symbols-outlined text-[20px] text-green-600">add_box</span>
          <div>
            <p class="text-sm font-medium">Multiple Classes</p>
            <p class="text-xs text-gray-500">Add 1-10 classes at once</p>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Search -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[20px]">search</span>
          <input id="searchInput"
                 type="text"
                 class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 placeholder="Search by class level...">
        </div>
      </div>

      <!-- School Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
        <select id="schoolFilter" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">All Schools</option>
          {% for school in schools %}
            <option value="{{ school.id }}" {% if selected_school == school.id|stringformat:"s" %}selected{% endif %}>{{ school.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        <select id="statusFilter" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>

    <!-- Results Count -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <p class="text-sm text-gray-600">
        Showing <span id="classCount" class="font-semibold">{{ classes|length }}</span> classes
      </p>
    </div>
  </div>

  <!-- Bulk Actions Bar (Hidden by default) -->
  <div id="bulkActionsBar" class="hidden bg-blue-50 border border-blue-200 rounded-xl shadow-sm p-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <span class="material-symbols-outlined text-blue-600 text-[24px]">check_circle</span>
      <span class="text-sm font-medium text-gray-900">
        <span id="selectedCount">0</span> classes selected
      </span>
    </div>
    <div class="flex items-center gap-3">
      <button id="clearSelectionBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
        Clear Selection
      </button>
      <a href="#" id="bulkAddBtn" class="flex items-center gap-2 px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors font-medium text-sm shadow-sm">
        <span class="material-symbols-outlined text-[20px]">add_box</span>
        <span>Add Selected Classes</span>
      </a>
    </div>
  </div>

  <!-- Classes Table -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50 border-b border-gray-200">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
              <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer">
            </th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">School</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Class Level</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Section</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Academic Year</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for class in classes %}
          <tr class="class-row hover:bg-gray-50 transition-colors" data-school="{{ class.school.id }}" data-name="{{ class.class_level|lower }}-{{ class.section|lower }}" data-status="{% if class.is_active %}active{% else %}inactive{% endif %}" data-class-id="{{ class.id }}">
            <td class="px-6 py-4 whitespace-nowrap">
              <input type="checkbox" class="class-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer" value="{{ class.id }}">
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-semibold text-sm">
                  <span class="material-symbols-outlined text-lg">school</span>
                </div>
                <span class="text-sm font-medium text-gray-900">{{ class.school.name }}</span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ class.class_level }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ class.section|default:"â€”" }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ class.academic_year }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium {% if class.is_active %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if class.is_active %}Active{% else %}Inactive{% endif %}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <a href="{% url 'assign_facilitator' class.id %}"
                 class="inline-flex items-center gap-1 px-3 py-1.5 border border-purple-500 text-purple-600 rounded-lg text-xs hover:bg-purple-50 transition-colors font-medium">
                <span class="material-symbols-outlined text-base">person_add</span>
                <span>Assign</span>
              </a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-6 py-12 text-center">
              <span class="material-symbols-outlined text-gray-300 text-5xl block mb-3">inbox</span>
              <p class="text-sm text-gray-500">No classes found</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Initialize filters on page load
document.addEventListener("DOMContentLoaded", function() {
  filterClasses();
  setupCheckboxes();
  
  // Add event listeners
  document.getElementById("searchInput").addEventListener("input", filterClasses);
  document.getElementById("schoolFilter").addEventListener("change", filterClasses);
  document.getElementById("statusFilter").addEventListener("change", filterClasses);
});

function filterClasses() {
  const searchQ = document.getElementById("searchInput").value.toLowerCase();
  const schoolId = document.getElementById("schoolFilter").value;
  const status = document.getElementById("statusFilter").value;
  let visibleCount = 0;

  document.querySelectorAll(".class-row").forEach(row => {
    const name = row.getAttribute("data-name");
    const rowSchool = row.getAttribute("data-school");
    const rowStatus = row.getAttribute("data-status");

    const matchesSearch = !searchQ || name.includes(searchQ);
    const matchesSchool = !schoolId || rowSchool === schoolId;
    const matchesStatus = !status || rowStatus === status;

    const isVisible = matchesSearch && matchesSchool && matchesStatus;
    row.classList.toggle("hidden", !isVisible);
    
    if (isVisible) visibleCount++;
  });

  document.getElementById("classCount").textContent = visibleCount;
  updateBulkActionsBar();
}

function setupCheckboxes() {
  const selectAllCheckbox = document.getElementById("selectAllCheckbox");
  const classCheckboxes = document.querySelectorAll(".class-checkbox");
  
  // Select all checkbox
  selectAllCheckbox.addEventListener("change", function() {
    classCheckboxes.forEach(checkbox => {
      const row = checkbox.closest(".class-row");
      if (!row.classList.contains("hidden")) {
        checkbox.checked = this.checked;
      }
    });
    updateBulkActionsBar();
  });
  
  // Individual checkboxes
  classCheckboxes.forEach(checkbox => {
    checkbox.addEventListener("change", function() {
      updateBulkActionsBar();
      updateSelectAllCheckbox();
    });
  });
  
  // Clear selection button
  document.getElementById("clearSelectionBtn").addEventListener("click", function(e) {
    e.preventDefault();
    classCheckboxes.forEach(checkbox => checkbox.checked = false);
    updateBulkActionsBar();
  });
  
  // Bulk add button
  document.getElementById("bulkAddBtn").addEventListener("click", function(e) {
    e.preventDefault();
    const selectedIds = Array.from(classCheckboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
      alert("Please select at least one class");
      return;
    }
    
    // Redirect with IDs as query parameters
    const queryString = selectedIds.map(id => `ids=${id}`).join('&');
    window.location.href = `{% url 'supervisor_bulk_add_classes' %}?${queryString}`;
  });
}

function updateBulkActionsBar() {
  const classCheckboxes = document.querySelectorAll(".class-checkbox");
  const selectedCount = Array.from(classCheckboxes).filter(cb => cb.checked).length;
  const bulkActionsBar = document.getElementById("bulkActionsBar");
  const selectedCountSpan = document.getElementById("selectedCount");
  
  selectedCountSpan.textContent = selectedCount;
  
  if (selectedCount > 0) {
    bulkActionsBar.classList.remove("hidden");
  } else {
    bulkActionsBar.classList.add("hidden");
  }
}

function updateSelectAllCheckbox() {
  const selectAllCheckbox = document.getElementById("selectAllCheckbox");
  const classCheckboxes = document.querySelectorAll(".class-checkbox:not(.hidden)");
  const visibleCheckboxes = Array.from(classCheckboxes).filter(cb => !cb.closest(".class-row").classList.contains("hidden"));
  const checkedCheckboxes = visibleCheckboxes.filter(cb => cb.checked);
  
  selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedCheckboxes.length === visibleCheckboxes.length;
  selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < visibleCheckboxes.length;
}
</script>

{% endblock %}
