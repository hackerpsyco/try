{% extends 'supervisor/shared/base.html' %}
{% block content %}

<div class="max-w-2xl mx-auto">
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-6 lg:p-8">
    
    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-900">Edit School</h2>
      <p class="text-sm text-gray-500 mt-2">Update school information</p>
    </div>

    <!-- Form -->
    <form method="post" enctype="multipart/form-data" class="space-y-6">
      {% csrf_token %}

      <!-- School Name -->
      <div>
        <label for="id_name" class="block text-sm font-medium text-gray-700 mb-2">School Name</label>
        {{ form.name }}
        {% if form.name.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- UDISE -->
      <div>
        <label for="id_udise" class="block text-sm font-medium text-gray-700 mb-2">UDISE Code</label>
        {{ form.udise }}
        {% if form.udise.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.udise.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Block -->
      <div>
        <label for="id_block" class="block text-sm font-medium text-gray-700 mb-2">Block</label>
        {{ form.block }}
        {% if form.block.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.block.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- District -->
      <div>
        <label for="id_district" class="block text-sm font-medium text-gray-700 mb-2">District</label>
        {{ form.district }}
        {% if form.district.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.district.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- State -->
      <div>
        <label for="id_state" class="block text-sm font-medium text-gray-700 mb-2">State</label>
        {{ form.state }}
        {% if form.state.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.state.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Cluster -->
      <div>
        <label for="id_cluster" class="block text-sm font-medium text-gray-700 mb-2">Cluster/Area</label>
        {{ form.cluster }}
        {% if form.cluster.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.cluster.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Area -->
      <div>
        <label for="id_area" class="block text-sm font-medium text-gray-700 mb-2">Area (Manual)</label>
        {{ form.area }}
        {% if form.area.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.area.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Address -->
      <div>
        <label for="id_address" class="block text-sm font-medium text-gray-700 mb-2">Address</label>
        {{ form.address }}
        {% if form.address.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.address.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Location Section -->
      <div class="border-t pt-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìç School Location</h3>
        
        <!-- Pincode Search -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Search by Pincode</label>
          <div class="flex gap-2">
            <input type="text" id="pincodeInput" placeholder="Enter pincode (e.g., 488001)" 
                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
            <button type="button" onclick="searchByPincode()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
              <span class="material-symbols-outlined inline mr-1">search</span>
              Search
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-1">Or click on map to pick exact location</p>
        </div>

        <!-- Auto-locate button -->
        <button type="button" id="autoLocateBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium mb-4" onclick="findDistrictLocation(event)">
          <span class="material-symbols-outlined inline mr-1">location_searching</span>
          Find District Location
        </button>

        <!-- Map Picker -->
        <div id="mapPicker" class="border border-gray-200 rounded-lg overflow-hidden mb-4" style="height: 600px;">
          <div id="pickMap" style="width: 100%; height: 100%;"></div>
        </div>

        <!-- Selected Location Info -->
        <div id="locationInfo" class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 mb-4" style="display: none;">
          <strong>‚úì Selected Location:</strong> <span id="selectedCoords"></span>
        </div>

        <!-- Latitude & Longitude -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="id_latitude" class="block text-sm font-medium text-gray-700 mb-2">Latitude</label>
            {{ form.latitude }}
            {% if form.latitude.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.latitude.errors.0 }}</p>
            {% endif %}
          </div>

          <div>
            <label for="id_longitude" class="block text-sm font-medium text-gray-700 mb-2">Longitude</label>
            {{ form.longitude }}
            {% if form.longitude.errors %}
              <p class="mt-1 text-sm text-red-600">{{ form.longitude.errors.0 }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Contact Person -->
      <div>
        <label for="id_contact_person" class="block text-sm font-medium text-gray-700 mb-2">Contact Person</label>
        {{ form.contact_person }}
        {% if form.contact_person.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.contact_person.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Contact Number -->
      <div>
        <label for="id_contact_number" class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
        {{ form.contact_number }}
        {% if form.contact_number.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.contact_number.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Email -->
      <div>
        <label for="id_email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
        {{ form.email }}
        {% if form.email.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Logo -->
      <div>
        <label for="id_logo" class="block text-sm font-medium text-gray-700 mb-2">Logo</label>
        {% if school.logo %}
          <div class="mb-3">
            <img src="{{ school.logo.url }}" alt="School Logo" class="h-20 w-20 rounded-lg object-cover">
          </div>
        {% endif %}
        {{ form.logo }}
        {% if form.logo.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.logo.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Profile Image -->
      <div>
        <label for="id_profile_image" class="block text-sm font-medium text-gray-700 mb-2">Profile Image</label>
        {% if school.profile_image %}
          <div class="mb-3">
            <img src="{{ school.profile_image.url }}" alt="School Profile" class="h-20 w-20 rounded-lg object-cover">
          </div>
        {% endif %}
        {{ form.profile_image }}
        {% if form.profile_image.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.profile_image.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Enrolled Students -->
      <div>
        <label for="id_enrolled_students" class="block text-sm font-medium text-gray-700 mb-2">Enrolled Students</label>
        {{ form.enrolled_students }}
        {% if form.enrolled_students.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.enrolled_students.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Average Attendance -->
      <div>
        <label for="id_avg_attendance_pct" class="block text-sm font-medium text-gray-700 mb-2">Average Attendance %</label>
        {{ form.avg_attendance_pct }}
        {% if form.avg_attendance_pct.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.avg_attendance_pct.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Validation Score -->
      <div>
        <label for="id_validation_score" class="block text-sm font-medium text-gray-700 mb-2">Validation Score</label>
        {{ form.validation_score }}
        {% if form.validation_score.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.validation_score.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Status -->
      <div>
        <label for="id_status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
        {{ form.status }}
        {% if form.status.errors %}
          <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
        {% endif %}
      </div>

      <!-- Form Errors -->
      {% if form.non_field_errors %}
        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
          <p class="text-sm text-red-700">
            {% for error in form.non_field_errors %}
              {{ error }}
            {% endfor %}
          </p>
        </div>
      {% endif %}

      <!-- Buttons -->
      <div class="flex gap-3 pt-6">
        <button type="submit" class="flex-1 px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-medium">
          Update School
        </button>
        <a href="{% url 'supervisor_schools_list' %}" class="flex-1 px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors font-medium text-center">
          Cancel
        </a>
      </div>
    </form>
  </div>
</div>

<style>
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="file"],
  select,
  textarea {
    width: 100%;
    padding: 0.625rem 1rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="tel"]:focus,
  input[type="file"]:focus,
  select:focus,
  textarea:focus {
    outline: none;
    ring: 2px;
    ring-color: #3b82f6;
    border-color: transparent;
  }

  textarea {
    resize: vertical;
    min-height: 100px;
  }
</style>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
let pickMap = null;
let pickMarker = null;
let schoolMarkers = [];

// Initialize interactive map picker
function initMapPicker() {
  const lat = parseFloat(document.getElementById('id_latitude').value) || 28.7041;
  const lng = parseFloat(document.getElementById('id_longitude').value) || 77.1025;
  
  pickMap = L.map('pickMap').setView([lat, lng], 16);
  
  // Use OpenStreetMap tiles with clear labels
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors',
    maxZoom: 19,
    minZoom: 3
  }).addTo(pickMap);
  
  // Add initial marker for current school
  if (lat && lng) {
    pickMarker = L.marker([lat, lng], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(pickMap);
    updateLocationInfo(lat, lng);
  }
  
  // Load all schools from database
  loadAllSchools();
  
  // Handle map clicks to place marker
  pickMap.on('click', function(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    
    // Update form fields
    document.getElementById('id_latitude').value = lat.toFixed(6);
    document.getElementById('id_longitude').value = lng.toFixed(6);
    
    // Update or create marker
    if (pickMarker) {
      pickMarker.setLatLng([lat, lng]);
    } else {
      pickMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(pickMap);
    }
    
    updateLocationInfo(lat, lng);
  });
}

// Load all schools and display on map
async function loadAllSchools() {
  try {
    const response = await fetch('/api/all-schools/');
    const data = await response.json();
    
    if (data.schools && data.schools.length > 0) {
      data.schools.forEach(school => {
        const lat = parseFloat(school.latitude);
        const lng = parseFloat(school.longitude);
        
        // Skip if coordinates are default or invalid
        if (isNaN(lat) || isNaN(lng) || (lat === 28.7041 && lng === 77.1025)) {
          return;
        }
        
        // Create small circle marker for other schools (blue)
        const marker = L.circleMarker([lat, lng], {
          radius: 5,
          fillColor: '#3b82f6',
          color: '#fff',
          weight: 1,
          opacity: 1,
          fillOpacity: 0.7
        }).bindPopup(`<strong>${school.name}</strong>`);
        
        marker.addTo(pickMap);
        schoolMarkers.push(marker);
      });
    }
  } catch (error) {
    console.error('Error loading schools:', error);
  }
}

// Update location info display
function updateLocationInfo(lat, lng) {
  document.getElementById('selectedCoords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  document.getElementById('locationInfo').style.display = 'block';
}

// Find district location using Nominatim
async function findDistrictLocation(event) {
  event.preventDefault();
  
  const district = document.getElementById('id_district').value;
  const state = document.getElementById('id_state').value;
  
  if (!district) {
    alert('Please select a district first');
    return;
  }
  
  try {
    // Use Nominatim to geocode the district
    const query = `${district}, ${state}, India`;
    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
    const data = await response.json();
    
    if (data && data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lng = parseFloat(data[0].lon);
      
      // Update form fields
      document.getElementById('id_latitude').value = lat.toFixed(6);
      document.getElementById('id_longitude').value = lng.toFixed(6);
      
      // Update map
      if (pickMap) {
        pickMap.setView([lat, lng], 10);
        if (pickMarker) {
          pickMarker.setLatLng([lat, lng]);
        } else {
          pickMarker = L.marker([lat, lng]).addTo(pickMap);
        }
      }
      
      updateLocationInfo(lat, lng);
    } else {
      alert('Location not found. Please check District/State and try again.');
    }
  } catch (error) {
    console.error('Error finding location:', error);
    alert('Error finding location. Please try again.');
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Initialize map
  setTimeout(() => initMapPicker(), 500);
});

// Search location by pincode
async function searchByPincode() {
  const pincode = document.getElementById('pincodeInput').value.trim();
  
  if (!pincode) {
    alert('Please enter a pincode');
    return;
  }
  
  try {
    // Use Nominatim to search by pincode
    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(pincode)}&format=json&limit=1`);
    const data = await response.json();
    
    if (data && data.length > 0) {
      const lat = parseFloat(data[0].lat);
      const lng = parseFloat(data[0].lon);
      
      // Update form fields
      document.getElementById('id_latitude').value = lat.toFixed(6);
      document.getElementById('id_longitude').value = lng.toFixed(6);
      
      // Update map
      if (pickMap) {
        pickMap.setView([lat, lng], 16);
        if (pickMarker) {
          pickMarker.setLatLng([lat, lng]);
        } else {
          pickMarker = L.marker([lat, lng]).addTo(pickMap);
        }
      }
      
      updateLocationInfo(lat, lng);
      alert(`Location found!`);
    } else {
      alert('Pincode not found. Please try another pincode.');
    }
  } catch (error) {
    console.error('Error searching pincode:', error);
    alert('Error searching pincode. Please try again.');
  }
}
</script>

{% endblock %}
