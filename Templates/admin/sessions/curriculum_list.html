{% extends "admin/shared/base.html" %}
{% load static %}

{% csrf_token %}

{% block extra_css %}
<style>
/* Only keeping curriculum table styles that require exact color matching */
.curriculum-table td {
  border: 1px solid #dee2e6;
}
.curriculum-table .s0 { background-color: #d9ead3 !important; }
.curriculum-table .s1 { background-color: #d9ead3 !important; }
.curriculum-table .s4 { background-color: #ffffff !important; }
.curriculum-table .s7 { background-color: #fde49a !important; }
.curriculum-table .s11 { background-color: #d9f1f3 !important; }
.curriculum-table .s21 { background-color: #fef1cc !important; }

/* Loading animation */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* CRITICAL: Override Google Sheets link hiding */
.ritz .waffle a {
  color: #0066cc !important;
  text-decoration: underline !important;
}

/* Link styles for curriculum content */
#curriculumContent a,
.curriculum-table a,
.waffle a,
.day-section a {
  color: #0066cc !important;
  text-decoration: underline !important;
  font-weight: 500 !important;
  transition: all 0.2s ease;
  cursor: pointer;
}

#curriculumContent a:hover,
.curriculum-table a:hover,
.waffle a:hover,
.day-section a:hover {
  color: #ffffff !important;
  background-color: #0066cc !important;
  text-decoration: none !important;
  padding: 2px 6px;
  border-radius: 4px;
}

#curriculumContent a:visited,
.curriculum-table a:visited,
.waffle a:visited,
.day-section a:visited {
  color: #551a8b !important;
}

/* External link indicator */
#curriculumContent a[href^="http"]::before,
.curriculum-table a[href^="http"]::before,
.waffle a[href^="http"]::before {
  content: "ðŸ”— ";
  font-size: 0.85em;
}

/* Make links visible in colored cells */
.s7 a, .s11 a, .s12 a, .s17 a, .s19 a, .s21 a, .s30 a, .s48 a {
  background-color: rgba(255, 255, 255, 0.9) !important;
  padding: 2px 6px !important;
  border-radius: 3px;
  border: 1px solid #0066cc !important;
  display: inline-block;
  margin: 1px 0;
}

/* Special styles for underlined link cells */
.s30 a, .s48 a {
  color: #1155cc !important;
  font-weight: bold !important;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'admin_sessions_filter' %}" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium inline-flex items-center">
        <span class="material-symbols-outlined text-lg mr-1">arrow_back</span>
        Back to List
    </a>
</div>

<div class="max-w-full mx-auto px-4">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h4 class="text-2xl font-bold mb-1 text-gray-900">Admin Curriculum Management</h4>
                <h5 class="text-lg text-gray-600">Master Curriculum Sessions (Days 1-150)</h5>
            </div>
            <div class="flex gap-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-600 text-white">
                    Day <span id="currentDayBadge" class="ml-1">1</span>
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-cyan-500 text-white">Admin View</span>
            </div>
        </div>
    </div>

    <!-- Language Selector -->
    <div class="mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h6 class="text-base font-semibold text-gray-900 flex items-center">
                        <i class="fas fa-language mr-2 text-gray-600"></i>
                        Select Curriculum Language
                    </h6>
                    <div class="flex rounded-lg border border-gray-300 overflow-hidden" id="languageSelector">
                        <input type="radio" class="hidden peer/english" name="language" id="englishBtn" value="english" checked>
                        <label for="englishBtn" class="flex items-center px-4 py-2 cursor-pointer bg-white text-gray-700 border-r border-gray-300 hover:bg-gray-50 peer-checked/english:bg-blue-600 peer-checked/english:text-white peer-checked/english:border-blue-600 transition-colors">
                            <i class="fas fa-globe mr-2"></i>English
                        </label>
                        
                        <input type="radio" class="hidden peer/hindi" name="language" id="hindiBtn" value="hindi">
                        <label for="hindiBtn" class="flex items-center px-4 py-2 cursor-pointer bg-white text-gray-700 hover:bg-gray-50 peer-checked/hindi:bg-blue-600 peer-checked/hindi:text-white transition-colors">
                            <i class="fas fa-language mr-2"></i>à¤¹à¤¿à¤‚à¤¦à¥€ (Hindi)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Day Navigator -->
    <div class="mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                    <h6 class="text-base font-semibold text-gray-900">Day Navigation</h6>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">Jump to day:</label>
                        <input type="number" id="jumpToDay" min="1" max="150" 
                               class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="1">
                        <button onclick="jumpToSpecificDay()" 
                                class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                            Go
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Actions -->
    <div class="mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="p-4">
                <h6 class="text-base font-semibold text-gray-900 mb-3">Admin Actions</h6>
                <div class="flex flex-wrap gap-2">
                    <button onclick="refreshCurriculumData()" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-blue-700 bg-white border border-blue-700 hover:bg-blue-50 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                    </button>
                    <a href="{% url 'admin_sessions_filter' %}" class="inline-flex items-center px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Sessions
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Curriculum Content -->
    <div class="mb-6">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-4 py-3 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <h6 class="text-base font-semibold text-gray-900" id="curriculumTitle">Day 1 - English Curriculum Content</h6>
                <div class="flex rounded-md shadow-sm">
                    <button onclick="navigateToPreviousDay()" id="prevDayBtn" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-l-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <i class="fas fa-chevron-left mr-1"></i> Previous
                    </button>
                    <button onclick="navigateToNextDay()" id="nextDayBtn" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border-l-0 border border-gray-300 rounded-r-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        Next <i class="fas fa-chevron-right ml-1"></i>
                    </button>
                </div>
            </div>
            <div class="p-0">
                <!-- Curriculum content will be loaded here -->
                <div id="curriculumContent" class="min-h-[400px] bg-gray-50">
                    <div class="text-center p-8">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-600"></div>
                        <p class="mt-4 text-gray-600">Loading Day 1 content...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Curriculum Data for JavaScript -->
<script id="adminCurriculumData" type="application/json">
{
    "currentDay": 1,
    "totalDays": 150,
    "curriculumUrl": "{% url 'curriculum_content_api' %}",
    "currentLanguage": "english",
    "sessionsData": {{ sessions_by_language|safe }},
    "hindiCount": {{ hindi_count }},
    "englishCount": {{ english_count }}
}
</script>

<script>
// Simple Admin Curriculum Navigator
class AdminCurriculumNavigator {
    constructor() {
        this.data = JSON.parse(document.getElementById('adminCurriculumData').textContent);
        this.currentDay = this.data.currentDay;
        this.totalDays = this.data.totalDays;
        this.currentLanguage = this.data.currentLanguage;
        this.sessionsData = this.data.sessionsData;
        this.cache = new Map();
        this.init();
    }

    init() {
        this.setupLanguageSelector();
        this.loadCurriculumContent(this.currentDay, this.currentLanguage);
        this.updateNavigationButtons();
    }

    setupLanguageSelector() {
        const languageInputs = document.querySelectorAll('input[name="language"]');
        languageInputs.forEach(input => {
            input.addEventListener('change', (e) => {
                if (e.target.checked) {
                    this.switchLanguage(e.target.value);
                }
            });
        });
    }

    switchLanguage(language) {
        this.currentLanguage = language;
        
        const url = new URL(window.location);
        url.searchParams.set('language', language);
        window.history.pushState({}, '', url);
        
        this.loadCurriculumContent(this.currentDay, language);
        this.updateTitle();
        
        this.showLanguageNotification(language);
    }

    showLanguageNotification(language) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-5 right-5 z-50 min-w-[300px] bg-green-50 border border-green-400 text-green-800 px-4 py-3 rounded-lg shadow-lg flex items-start justify-between';
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-600"></i>
                <span>Switched to ${language === 'hindi' ? 'à¤¹à¤¿à¤‚à¤¦à¥€ (Hindi)' : 'English'} curriculum</span>
            </div>
            <button onclick="this.parentElement.remove()" class="ml-4 text-green-800 hover:text-green-900">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
    }

    hasSessionForDay(day, language) {
        const sessions = this.sessionsData[language] || [];
        return sessions.some(session => session.day_number === day);
    }

    async loadCurriculumContent(day, language = null) {
        if (!language) language = this.currentLanguage;
        
        const contentDiv = document.getElementById('curriculumContent');
        
        contentDiv.innerHTML = `
            <div class="text-center p-8">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-blue-600"></div>
                <p class="mt-4 text-gray-600">Loading Day ${day} ${language === 'hindi' ? 'Hindi' : 'English'} content...</p>
            </div>
        `;

        try {
            const cacheKey = `${language}_${day}`;
            
            if (this.cache.has(cacheKey)) {
                contentDiv.innerHTML = this.cache.get(cacheKey);
                this.highlightLinks();
                return;
            }

            const response = await fetch(`${this.data.curriculumUrl}?day=${day}&language=${language}`);
            if (!response.ok) throw new Error('Failed to load content');
            
            const content = await response.text();
            this.cache.set(cacheKey, content);
            
            const adminContent = this.wrapContentWithAdminActions(content, day, language);
            contentDiv.innerHTML = adminContent;
            
            // Highlight links after content is loaded
            this.highlightLinks();
            
        } catch (error) {
            contentDiv.innerHTML = `
                <div class="m-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <h6 class="text-lg font-semibold text-red-800 mb-2">Error Loading Content</h6>
                    <p class="text-red-700 mb-4">Failed to load Day ${day} ${language === 'hindi' ? 'Hindi' : 'English'} curriculum content.</p>
                    <div class="flex gap-2">
                        <button onclick="window.adminCurriculumNav.loadCurriculumContent(${day}, '${language}')" class="px-4 py-2 text-sm font-medium text-red-700 bg-white border border-red-700 rounded-md hover:bg-red-50">
                            Retry
                        </button>
                        <a href="/admin/curriculum-sessions/create/?day=${day}&language=${language}" class="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                            Create Session for Day ${day}
                        </a>
                    </div>
                </div>
            `;
        }
    }

    highlightLinks() {
        // Force link styling with JavaScript
        setTimeout(() => {
            const allLinks = document.querySelectorAll('#curriculumContent a, .curriculum-table a, .ritz a, .waffle a');
            
            allLinks.forEach(link => {
                // Force link visibility
                link.style.color = '#0066cc';
                link.style.textDecoration = 'underline';
                link.style.fontWeight = '500';
                link.style.cursor = 'pointer';
                
                // Add external link attributes
                if (link.href && link.hostname !== window.location.hostname) {
                    link.setAttribute('target', '_blank');
                    link.setAttribute('rel', 'noopener noreferrer');
                }
                
                // Enhanced hover effects
                link.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#0066cc';
                    this.style.color = '#ffffff';
                    this.style.padding = '2px 6px';
                    this.style.borderRadius = '4px';
                });
                
                link.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'transparent';
                    this.style.color = '#0066cc';
                    this.style.padding = '0';
                });
            });
        }, 100);
    }

    wrapContentWithAdminActions(content, day, language) {
        const hasSession = this.hasSessionForDay(day, language);
        const session = hasSession ? this.getSessionForDay(day, language) : null;
        
        let adminActions = '';
        if (hasSession && session) {
            adminActions = `
                <div class="m-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <strong class="text-blue-900 text-sm font-semibold">Session Available:</strong> 
                            <span class="text-blue-800">${session.title || 'Day ' + day + ' Session'}</span>
                            <br><small class="text-blue-600 text-xs">Status: ${session.status || 'Draft'}</small>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <a href="/admin/curriculum-sessions/${session.id}/edit/" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-700 bg-white border border-blue-700 rounded-md hover:bg-blue-50">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </a>
                            <a href="/admin/curriculum-sessions/${session.id}/preview/" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-cyan-700 bg-white border border-cyan-700 rounded-md hover:bg-cyan-50">
                                <i class="fas fa-eye mr-1"></i> Preview
                            </a>
                            <a href="/admin/curriculum-sessions/${session.id}/delete/" class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-red-700 bg-white border border-red-700 rounded-md hover:bg-red-50">
                                <i class="fas fa-trash mr-1"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
            `;
        } else {
            adminActions = `
               
            `;
        }
        
        return adminActions + content;
    }

    getSessionForDay(day, language) {
        const sessions = this.sessionsData[language] || [];
        return sessions.find(session => session.day_number === day);
    }

    navigateToDay(day) {
        if (day < 1 || day > this.totalDays) return;
        
        const url = new URL(window.location);
        url.searchParams.set('day', day);
        window.history.pushState({}, '', url);
        
        this.currentDay = day;
        
        document.getElementById('currentDayBadge').textContent = day;
        document.getElementById('jumpToDay').value = day;
        
        this.updateTitle();
        this.updateNavigationButtons();
        this.loadCurriculumContent(day, this.currentLanguage);
    }

    updateTitle() {
        const title = `Day ${this.currentDay} - ${this.currentLanguage === 'hindi' ? 'Hindi' : 'English'} Curriculum Content`;
        document.getElementById('curriculumTitle').textContent = title;
        document.title = `Admin - ${title}`;
    }

    updateNavigationButtons() {
        const prevBtn = document.getElementById('prevDayBtn');
        const nextBtn = document.getElementById('nextDayBtn');
        
        prevBtn.disabled = this.currentDay <= 1;
        nextBtn.disabled = this.currentDay >= this.totalDays;
    }
}

// Global functions
function jumpToSpecificDay() {
    const dayInput = document.getElementById('jumpToDay');
    const day = parseInt(dayInput.value);
    
    if (day >= 1 && day <= 150) {
        window.adminCurriculumNav.navigateToDay(day);
    } else {
        alert('Please enter a day between 1 and 150');
        dayInput.focus();
    }
}

function navigateToPreviousDay() {
    if (window.adminCurriculumNav.currentDay > 1) {
        window.adminCurriculumNav.navigateToDay(window.adminCurriculumNav.currentDay - 1);
    }
}

function navigateToNextDay() {
    if (window.adminCurriculumNav.currentDay < 150) {
        window.adminCurriculumNav.navigateToDay(window.adminCurriculumNav.currentDay + 1);
    }
}

function refreshCurriculumData() {
    location.reload();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    window.adminCurriculumNav = new AdminCurriculumNavigator();
    
    const urlParams = new URLSearchParams(window.location.search);
    const urlDay = parseInt(urlParams.get('day')) || 1;
    const urlLanguage = urlParams.get('language') || 'english';
    
    if (urlLanguage && ['english', 'hindi'].includes(urlLanguage)) {
        document.getElementById(urlLanguage + 'Btn').checked = true;
        window.adminCurriculumNav.currentLanguage = urlLanguage;
    }
    
    if (urlDay !== 1) {
        window.adminCurriculumNav.navigateToDay(urlDay);
    }
    
    // Add keyboard navigation
    document.addEventListener('keydown', function(e) {
        // Only handle keyboard shortcuts when not typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                navigateToPreviousDay();
                break;
            case 'ArrowRight':
                e.preventDefault();
                navigateToNextDay();
                break;
        }
    });
    
    // Add Enter key support for jump to day input
    document.getElementById('jumpToDay').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            jumpToSpecificDay();
        }
    });
});

// Handle browser navigation
window.addEventListener('popstate', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const day = parseInt(urlParams.get('day')) || 1;
    const language = urlParams.get('language') || 'english';
    
    document.getElementById(language + 'Btn').checked = true;
    window.adminCurriculumNav.currentLanguage = language;
    window.adminCurriculumNav.navigateToDay(day);
});
</script>

{% endblock %}