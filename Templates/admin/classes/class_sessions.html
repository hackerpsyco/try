{% extends 'admin/shared/base.html' %}
{% load static %}

{% block content %}

<!-- Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
  <div>
    <h5 class="text-lg font-semibold text-gray-900">
      {{ class_section.class_level }} - Section {{ class_section.section }}
    </h5>
    <p class="text-gray-500 text-sm">Planned Sessions & Progress</p>
  </div>

  <div class="flex gap-2">
    <a href="{% url 'planned_session_create' class_section.id %}"
       class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
      âž• Add Session
    </a>

    <a href="{% url 'planned_session_import' class_section.id %}"
       class="px-4 py-2 border border-blue-500 text-blue-600 rounded-lg text-sm hover:bg-blue-50">
      â¬† Import Sessions
    </a>
  </div>
</div>

<!-- Next Pending Session -->
<div class="bg-white border border-gray-200 rounded-xl shadow-sm mb-5">
  <div class="p-4">
    <h6 class="font-semibold mb-2 text-gray-800">Next Pending Session</h6>

    {% for ps in planned_sessions %}
      {% if not ps.is_conducted %}
        <span class="inline-block px-3 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700 mb-2">
          Pending
        </span>

        <p class="text-gray-800">
          <strong>Day {{ ps.day_number }}:</strong> {{ ps.topic }}
        </p>
      
      {% endif %}
    {% empty %}
      <span class="inline-block px-3 py-1 text-sm rounded-full bg-green-100 text-green-700">
        All sessions completed ðŸŽ‰
      </span>
    {% endfor %}
  </div>
</div>

<!-- Bulk Actions -->
<div id="bulkActions"
     class="hidden bg-white border border-gray-200 rounded-xl shadow-sm mb-4">
  <div class="px-4 py-2 flex items-center justify-between">
    <span class="text-gray-500 text-sm">
      <span id="selectedCount">0</span> session(s) selected
    </span>

    <button type="button"
            onclick="bulkDelete()"
            class="px-3 py-1.5 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700">
      ðŸ—‘ Delete Selected
    </button>
  </div>
</div>

<!-- Sessions Table -->
<form id="bulkForm">
  {% csrf_token %}

  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50 text-left text-sm text-gray-600">
          <tr>
            <th class="p-3 w-10">
              <input id="selectAll" type="checkbox"
                     class="h-4 w-4 rounded border-gray-300">
            </th>
            <th class="p-3 w-20 font-semibold">Day</th>
            <th class="p-3 font-semibold">Topic</th>
            <th class="p-3 w-32 font-semibold">Status</th>
            <th class="p-3 text-right w-40 font-semibold">Actions</th>
          </tr>
        </thead>

        <tbody class="divide-y">

        {% for ps in planned_sessions %}
          <tr class="hover:bg-gray-50">
            <td class="p-3">
              <input type="checkbox"
                     name="session_ids"
                     value="{{ ps.id }}"
                     class="session-checkbox h-4 w-4 rounded border-gray-300">
            </td>

            <td class="p-3 font-semibold text-gray-800">
              Day {{ ps.day_number }}
            </td>

            <td class="p-3">
              <div class="font-medium text-gray-900">
                {{ ps.topic }}
              </div>

              {% if ps.youtube_url %}
              <a href="{{ ps.youtube_url }}"
                 target="_blank"
                 class="text-blue-600 text-sm hover:underline">
                â–¶ View Video
              </a>
              {% endif %}
            </td>

            <td class="p-3">
              <span class="px-3 py-1 text-xs rounded-full
                {% if ps.status_class == 'success' %}
                  bg-green-100 text-green-700
                {% elif ps.status_class == 'warning' %}
                  bg-yellow-100 text-yellow-700
                {% else %}
                  bg-gray-200 text-gray-700
                {% endif %}
              ">
                {{ ps.status_info|title }}
              </span>
            </td>

            <td class="p-3 text-right">

              <a href="{% url 'planned_session_edit' ps.id %}"
                 class="px-3 py-1.5 border border-blue-500 text-blue-600 rounded-lg text-xs hover:bg-blue-50 mr-1">
                Edit
              </a>

              <a href="{% url 'planned_session_delete' ps.id %}"
                 onclick="return confirm('Are you sure you want to delete this planned session?{% if ps.status_info != 'pending' %} This will also delete all related attendance data.{% endif %}');"
                 class="px-3 py-1.5 border border-red-500 text-red-600 rounded-lg text-xs hover:bg-red-50">
                Delete
              </a>

              {% if ps.status_info != 'pending' %}
                <div class="text-xs text-yellow-600 mt-1">
                  âš  Has attendance data
                </div>
              {% endif %}
            </td>
          </tr>

        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-gray-500 py-6">
              No planned sessions added yet.
            </td>
          </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>

  </div>
</form>

<script>
// Select all
document.getElementById("selectAll").addEventListener("change", function() {
  document.querySelectorAll(".session-checkbox")
    .forEach(cb => cb.checked = this.checked);
  updateBulkActions();
});

document.querySelectorAll(".session-checkbox")
  .forEach(cb => cb.addEventListener("change", updateBulkActions));

function updateBulkActions() {
  const selected = document.querySelectorAll(".session-checkbox:checked");
  const bulkPanel = document.getElementById("bulkActions");
  const count = document.getElementById("selectedCount");

  if (selected.length > 0) {
    bulkPanel.classList.remove("hidden");
    count.textContent = selected.length;
  } else {
    bulkPanel.classList.add("hidden");
  }

  const all = document.querySelectorAll(".session-checkbox");
  const selectAll = document.getElementById("selectAll");
  selectAll.checked = selected.length === all.length;
  selectAll.indeterminate =
    selected.length > 0 && selected.length < all.length;
}

function bulkDelete() {
  const selected = document.querySelectorAll(".session-checkbox:checked");
  if (!selected.length) return alert("Please select sessions to delete.");

  if (confirm(`Delete ${selected.length} session(s)? This will also delete all related attendance data.`)) {
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "{% url 'bulk_delete_sessions' class_section.id %}";

    const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;
    form.innerHTML = `<input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">`;

    selected.forEach(cb => {
      form.innerHTML += `<input type="hidden" name="session_ids" value="${cb.value}">`;
    });

    document.body.appendChild(form);
    form.submit();
  }
}
</script>

{% endblock %}
