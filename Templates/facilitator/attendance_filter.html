{% extends "facilitator/shared/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold">Attendance Management</h4>
</div>

<!-- Cascading Filter Interface -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">Filter Options</h6>
    </div>
    <div class="card-body">
        <form method="GET" id="attendanceFilterForm">
            <div class="row g-3">
                <!-- School Selection -->
                <div class="col-md-4">
                    <label for="schoolSelect" class="form-label">Select School</label>
                    <select class="form-select" id="schoolSelect" name="school">
                        <option value="">Choose a school...</option>
                        {% for fs in assigned_schools %}
                        <option value="{{ fs.school.id }}" 
                                {% if selected_school and selected_school.id == fs.school.id %}selected{% endif %}>
                            {{ fs.school.name }} ({{ fs.school.district }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Class Selection -->
                <div class="col-md-4">
                    <label for="classSelect" class="form-label">Select Class</label>
                    <select class="form-select" id="classSelect" name="class_section" disabled>
                        <option value="">Choose a class...</option>
                        {% if class_sections %}
                            {% for class_section in class_sections %}
                            <option value="{{ class_section.id }}"
                                    {% if selected_class_section and selected_class_section.id == class_section.id %}selected{% endif %}>
                                Class {{ class_section.class_level }} - {{ class_section.section }}
                            </option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <!-- Filter Button -->
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Apply Filter</button>
                    <a href="{% url 'facilitator_attendance' %}" class="btn btn-outline-secondary">Clear</a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Students List (if class is selected) -->
{% if selected_class_section and enrollment_stats %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            Students in {{ selected_school.name }} - Class {{ selected_class_section.class_level }}-{{ selected_class_section.section }}
        </h6>
        <span class="badge bg-primary">{{ enrollment_stats|length }} students</span>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Enrollment No.</th>
                        <th>Student Name</th>
                        <th>Total Sessions</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Attendance %</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in enrollment_stats %}
                    <tr>
                        <td>{{ stat.enrollment.student.enrollment_number }}</td>
                        <td>{{ stat.enrollment.student.full_name }}</td>
                        <td>
                            <span class="badge bg-info">{{ stat.total_sessions }}</span>
                        </td>
                        <td>
                            <span class="badge bg-success">{{ stat.present_count }}</span>
                        </td>
                        <td>
                            <span class="badge bg-danger">{{ stat.absent_count }}</span>
                        </td>
                        <td>
                            {% if stat.attendance_percentage >= 75 %}
                                <span class="badge bg-success">{{ stat.attendance_percentage }}%</span>
                            {% elif stat.attendance_percentage >= 50 %}
                                <span class="badge bg-warning">{{ stat.attendance_percentage }}%</span>
                            {% else %}
                                <span class="badge bg-danger">{{ stat.attendance_percentage }}%</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="viewStudentAttendance('{{ stat.enrollment.student.id }}')">
                                View Details
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Recent Sessions (if class is selected) -->
{% if selected_class_section and recent_sessions_data %}
<div class="card">
    <div class="card-header">
        <h6 class="mb-0">Recent Sessions with Attendance</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Topic</th>
                        <th>Status</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Total</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session_data in recent_sessions_data %}
                    <tr>
                        <td>{{ session_data.session.date|date:"M d, Y" }}</td>
                        <td>Day {{ session_data.session.planned_session.day_number }}</td>
                        <td>{{ session_data.session.planned_session.topic }}</td>
                        <td>
                            <span class="badge bg-success">{{ session_data.session.status|title }}</span>
                        </td>
                        <td>
                            <span class="badge bg-success">{{ session_data.present_count }}</span>
                        </td>
                        <td>
                            <span class="badge bg-danger">{{ session_data.absent_count }}</span>
                        </td>
                        <td>
                            <span class="badge bg-info">{{ session_data.total_count }}</span>
                        </td>
                        <td>
                            <a href="{% url 'mark_attendance' session_data.session.id %}" 
                               class="btn btn-sm btn-outline-primary">
                                View/Edit
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- No Selection State -->
{% if not selected_school %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-funnel fs-1 text-muted mb-3"></i>
        <h5 class="text-muted">Select a school to view attendance options</h5>
        <p class="text-muted">Use the filters above to navigate through your assigned schools and classes.</p>
        
        {% if not assigned_schools %}
        <div class="alert alert-warning mt-3">
            <strong>No Schools Assigned:</strong> You are not assigned to any schools. Please contact the administrator to assign you to schools.
        </div>
        {% else %}
        <div class="alert alert-info mt-3">
            <strong>Available Schools:</strong> You have access to {{ assigned_schools|length }} school(s).
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if selected_school and not selected_class_section %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-people fs-1 text-muted mb-3"></i>
        <h5 class="text-muted">Select a class to view students</h5>
        <p class="text-muted">Choose a class from {{ selected_school.name }} to see enrolled students.</p>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const schoolSelect = document.getElementById('schoolSelect');
    const classSelect = document.getElementById('classSelect');
    
    // Handle school selection change
    schoolSelect.addEventListener('change', function() {
        const schoolId = this.value;
        
        // Reset and disable class select
        classSelect.innerHTML = '<option value="">Choose a class...</option>';
        classSelect.disabled = !schoolId;
        
        if (schoolId) {
            // Fetch classes for selected school
            fetch(`/api/facilitator/classes/?school_id=${schoolId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.classes) {
                        data.classes.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.id;
                            option.textContent = `Class ${cls.class_level} - ${cls.section}`;
                            classSelect.appendChild(option);
                        });
                        classSelect.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error fetching classes:', error);
                    alert('Error loading classes. Please try again.');
                });
        }
    });
    
    // Auto-submit form when class is selected
    classSelect.addEventListener('change', function() {
        if (this.value) {
            document.getElementById('attendanceFilterForm').submit();
        }
    });
});

function viewStudentAttendance(studentId) {
    // This could open a modal or navigate to a detailed view
    alert('Student attendance view - to be implemented');
}
</script>

{% endblock %}