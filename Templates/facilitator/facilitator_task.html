{% extends "facilitator/shared/base.html" %}

{% block title %}Facilitator Task - Preparation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="container">
        <!-- Header -->
        <div class="mb-4">
            <h1 class="h2 fw-bold text-dark">Facilitator Task - Preparation</h1>
            <p class="text-muted">{{ actual_session.planned_session.class_section.display_name }} - {{ actual_session.date }}</p>
            
            <!-- Grouped Session Notice -->
            {% if is_grouped_session %}
            <div class="alert alert-info mt-3">
                <strong>üîó Grouped Session</strong><br>
                <small>This task applies to ALL grouped classes:
                    {% for grouped_class in grouped_classes %}
                        <span class="badge bg-info">{{ grouped_class.display_name }}</span>
                    {% endfor %}
                </small>
            </div>
            {% endif %}
        </div>

        <!-- Task Completion Status -->
        <div class="card mb-4 {% if task_count > 0 %}border-success{% else %}border-warning{% endif %}">
            <div class="card-header {% if task_count > 0 %}bg-success{% else %}bg-warning{% endif %} text-white">
                <h5 class="mb-0">
                    {% if task_count > 0 %}
                        ‚úÖ Tasks Completed: {{ task_count }}
                    {% else %}
                        ‚ö†Ô∏è No Tasks Submitted Yet
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if task_count == 0 %}
                    <div class="alert alert-warning mb-0">
                        <strong>Please complete at least ONE of the following tasks:</strong>
                        <ul class="mb-0 mt-2">
                            <li>üì∑ Take a Photo</li>
                            <li>üé• Take a Video</li>
                            <li>üëç Add a Facebook Link</li>
                        </ul>
                    </div>
                {% else %}
                    <p class="mb-0 text-success">
                        <i class="bi bi-check-circle"></i> Great! You have completed {{ task_count }} task(s). 
                        You can now proceed to mark attendance.
                    </p>
                {% endif %}
            </div>
        </div>

        <!-- Lesson Plan Content (if available) -->
        {% if curriculum_session %}
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> Lesson Plan - Day {{ planned_session.day_number }}
                </h5>
            </div>
            <div class="card-body">
                {% if curriculum_session.title %}
                <h6 class="mb-3">{{ curriculum_session.title }}</h6>
                {% endif %}
                
                {% if curriculum_session.learning_objectives %}
                <div class="mb-3">
                    <strong>Learning Objectives:</strong>
                    <div class="mt-2 p-3 bg-light rounded">
                        {{ curriculum_session.learning_objectives|linebreaks }}
                    </div>
                </div>
                {% endif %}
                
                {% if curriculum_session.content %}
                <div class="mb-3">
                    <strong>Content:</strong>
                    <div class="mt-2 p-3 bg-light rounded">
                        {{ curriculum_session.content|linebreaks }}
                    </div>
                </div>
                {% endif %}
                
                {% if curriculum_session.activities %}
                <div class="mb-3">
                    <strong>Activities:</strong>
                    <div class="mt-2 p-3 bg-light rounded">
                        <pre>{{ curriculum_session.activities|safe }}</pre>
                    </div>
                </div>
                {% endif %}
                
                {% if curriculum_session.resources %}
                <div class="mb-3">
                    <strong>Resources:</strong>
                    <div class="mt-2 p-3 bg-light rounded">
                        <pre>{{ curriculum_session.resources|safe }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Task Options -->
        <div class="row mb-4">
            <!-- Option 1: Take Photo -->
            <div class="col-md-4 mb-3">
                <div class="card border-primary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">üì∑ Take Photo</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">Capture a photo directly from your camera</p>
                        <button type="button" class="btn btn-primary w-100" id="btn-take-photo">
                            <i class="bi bi-camera"></i> Open Camera
                        </button>
                        <input type="file" id="photo-input" accept="image/*" capture="environment" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Option 2: Take Video -->
            <div class="col-md-4 mb-3">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üé• Take Video</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">Record a video directly from your camera</p>
                        <button type="button" class="btn btn-success w-100" id="btn-take-video">
                            <i class="bi bi-camera-video"></i> Open Camera
                        </button>
                        <input type="file" id="video-input" accept="video/*" capture="environment" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Option 3: Facebook Link -->
            <div class="col-md-4 mb-3">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üëç Facebook Link</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted">Share a Facebook post or video link</p>
                        <button type="button" class="btn btn-info w-100" data-bs-toggle="modal" data-bs-target="#facebookModal">
                            <i class="bi bi-facebook"></i> Add Link
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Existing Tasks -->
        {% if existing_tasks %}
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">üìã Uploaded Tasks ({{ existing_tasks.count }})</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for task in existing_tasks %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card">
                            {% if task.media_type == 'photo' %}
                                <img src="{{ task.media_file.url }}" class="card-img-top" alt="Photo" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h6 class="card-title">üì∑ Photo</h6>
                                    <p class="card-text text-muted small">{{ task.created_at|date:"M d, Y H:i" }}</p>
                                    {% if task.description %}
                                    <p class="card-text">{{ task.description }}</p>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteTask('{{ task.id }}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            {% elif task.media_type == 'video' %}
                                <div class="card-body">
                                    <h6 class="card-title">üé• Video</h6>
                                    <video width="100%" height="200" controls style="background: #000;">
                                        <source src="{{ task.media_file.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                    <p class="card-text text-muted small mt-2">{{ task.created_at|date:"M d, Y H:i" }}</p>
                                    {% if task.description %}
                                    <p class="card-text">{{ task.description }}</p>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteTask('{{ task.id }}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            {% elif task.media_type == 'facebook_link' %}
                                <div class="card-body">
                                    <h6 class="card-title">üëç Facebook Link</h6>
                                    <a href="{{ task.facebook_link }}" target="_blank" class="btn btn-sm btn-primary mb-2">
                                        <i class="bi bi-box-arrow-up-right"></i> Open Link
                                    </a>
                                    <p class="card-text text-muted small">{{ task.created_at|date:"M d, Y H:i" }}</p>
                                    {% if task.description %}
                                    <p class="card-text">{{ task.description }}</p>
                                    {% endif %}
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteTask('{{ task.id }}')">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="d-flex gap-2">
            <a href="{% url 'facilitator_today_session' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            
            {% if task_count > 0 %}
                <!-- Task completed - show proceed button -->
                <form method="POST" action="{% url 'facilitator_task_complete' actual_session.id %}" style="flex: 1;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-check-lg"></i> 
                        {% if is_grouped_session %}
                            Complete & Mark Attendance ({{ grouped_classes|length }} Classes)
                        {% else %}
                            Complete & Mark Attendance
                        {% endif %}
                    </button>
                </form>
            {% else %}
                <!-- No task completed - disable proceed button -->
                <button type="button" class="btn btn-success w-100" disabled title="Please complete at least one task first">
                    <i class="bi bi-check-lg"></i> Complete & Mark Attendance (Complete a task first)
                </button>
            {% endif %}
            
            <a href="{% url 'mark_attendance' actual_session.id %}" class="btn btn-warning">
                <i class="bi bi-skip-forward"></i> Skip Task
            </a>
        </div>
    </div>
</div>

<!-- Facebook Link Modal -->
<div class="modal fade" id="facebookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Facebook Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="facebook-link" class="form-label">Facebook Link *</label>
                    <input type="url" class="form-control" id="facebook-link" placeholder="https://www.facebook.com/...">
                </div>
                <div class="mb-3">
                    <label for="facebook-description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="facebook-description" rows="3" placeholder="Add a description..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addFacebookLink()">Add Link</button>
            </div>
        </div>
    </div>
</div>

<script>
// Photo capture
document.getElementById('btn-take-photo').addEventListener('click', function() {
    document.getElementById('photo-input').click();
});

document.getElementById('photo-input').addEventListener('change', function(e) {
    if (this.files.length > 0) {
        uploadPhoto(this.files[0]);
    }
});

// Video capture
document.getElementById('btn-take-video').addEventListener('click', function() {
    document.getElementById('video-input').click();
});

document.getElementById('video-input').addEventListener('change', function(e) {
    if (this.files.length > 0) {
        uploadVideo(this.files[0]);
    }
});

// Upload photo
function uploadPhoto(file) {
    const formData = new FormData();
    formData.append('photo', file);
    formData.append('description', '');
    
    fetch('{% url "facilitator_task_upload_photo" actual_session.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Photo uploaded successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Upload failed');
    });
}

// Upload video
function uploadVideo(file) {
    const formData = new FormData();
    formData.append('video', file);
    formData.append('description', '');
    
    fetch('{% url "facilitator_task_upload_video" actual_session.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Video uploaded successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Upload failed');
    });
}

// Add Facebook link
function addFacebookLink() {
    const link = document.getElementById('facebook-link').value;
    const description = document.getElementById('facebook-description').value;
    
    if (!link) {
        alert('Please enter a Facebook link');
        return;
    }
    
    const formData = new FormData();
    formData.append('facebook_link', link);
    formData.append('description', description);
    
    fetch('{% url "facilitator_task_facebook_link" actual_session.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Facebook link added successfully!');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add link');
    });
}

// Delete task
function deleteTask(taskId) {
    if (confirm('Are you sure you want to delete this task?')) {
        fetch('/facilitator/task/' + taskId + '/delete/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Task deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Delete failed');
        });
    }
}
</script>
{% endblock %}
